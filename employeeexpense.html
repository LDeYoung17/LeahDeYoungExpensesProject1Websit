<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link href="employeesexpenses.css" rel="stylesheet">

    <title>Employee expenses</title>
</head>
<body>
    <div id="createexpensediv">
        <h3>Enter expense information</h3>
        <table>
        <thead><tr><th>Expense amount</th><th>Reason</th><th>Date submitted</th><th>Employee ID</th><th>Manager ID</th></tr>
        </thead>
        <tbody>
            <tr><td><input id="expenseAmount", type="text"></td><td><input id="reason", type="text"></td><td><input id="dateSubmitted", type="text"></td><td><input id="employeeId", type="text"></td><td><input id="managerId", type="text"></td></tr>
        </tbody>
        <button id="createexpense", onclick="createExpense()">Create Expense</button>
    </table>
    </div>

    <div id="searchdiv">
        <label for="expenseByStatus">Enter expense status</label>
        <input id="expenseByStatus", type = "text">
        <button onclick="getExpenseByStatus()">Get Expenses</button>
    </div>

    <div id="searchdiv">
        <label for="expenseByDateSubmitted">Enter expense submission date</label>
        <input id="expenseByDateSubmitted", type = "text">
        <button onclick = "getExpenseByDateSubmitted()">Get Expenses</button>
    </div>

    <div id="searchdiv">
        <label for="expenseByStatusDate">Enter expense status date</label>
        <input id = "expenseByStatusDate", type = "text">
        <button onclick = "getExpenseByStatusDate()">Get Expenses</button>
    </div>

    <div id="searchdiv">
        <button onclick = "getAllExpenses()">All Expenses</button>
    </div>

    <div id="resultstable">
        <table>
            <thead><tr><th>Expense ID</th><th>Expense amount</th><th>Reason</th><th>Date submitted</th><th>Employee ID</th><th>Manager ID</th><th>Status</th><th>Status Date</th><th>Manager Notes</th></tr>
            </thead>        
            <tbody id = "expenseTableBody">
            </tbody>

        </table>
    </div>
    <div id="logout">
        <button id="logout", onclick="logout()">Log out</button>
    </div>
    
</body>
<script>
    const expenseTableBody = document.getElementById("expenseTableBody");
    const expenseByDateSubmitted = document.getElementById("expenseByDateSubmitted");
    const expenseByStatus = document.getElementById("expenseByStatus");
    const expenseByStatusDate = document.getElementById("expenseByStatusDate");
    const jwt = localStorage.getItem("jwt");
    const decodedJWT = parseJWT(jwt);
    const EmployeeId = decodedJWT.id;


    function parseJWT (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
    }  

    async function createExpense(){
        const expenseAmountInput = document.getElementById("expenseAmount");
        const expenseAmount = expenseAmountInput.value;
        const reasonInput = document.getElementById("reason");
        const expenseReason = reasonInput.value;
        const dateSubmittedInput = document.getElementById("dateSubmitted");
        const dateSubmitted = dateSubmittedInput.value;
        const employeeIdInput = document.getElementById("employeeId");
        const employeeId = employeeIdInput.value;
        const managerIdInput = document.getElementById("managerId");
        const managerId = managerIdInput.value;
    
        const expense = {
            expenseId:0,
            expenseAmount: expenseAmount,
            reason: expenseReason,
            dateSubmitted: dateSubmitted,
            employeeId: employeeId,
            managerId: managerId,
            status: "Pending",
            statusDate: dateSubmitted,
            managerNotes: "none"
        }
        const details ={
            method:"POST",
            headers:{Authorization:jwt},
            body:JSON.stringify(expense)
        } 

        console.log(details.body);
        
        const httpResponse = await fetch("http://localhost:7000/expenses",details);

        if(httpResponse.status === 201){
        alert("Your expense was created");
        }else{
            alert("Error! please try again");
        }
    }

    async function getAllExpenses(){

        details = {
            method:'GET', 
            headers:{Authorization:jwt}
        };

        
            const httpResponse = await fetch(`http://localhost:7000/expenses/employee/${EmployeeId}`, details); 
            const expenses = await httpResponse.json(); 

            let tbodyHtml = "";

            for(const expense of expenses){
                tbodyHtml += `
                <tr>
                <td>${expense.expenseId}</td>
                <td>${expense.expenseAmount}</td>
                <td>${expense.reason}</td>
                <td>${expense.dateSubmitted}</td>
                <td>${expense.employeeId}</td>
                <td>${expense.managerId}</td>
                <td>${expense.status}</td>
                <td>${expense.statusDate}</td>
                <td>${expense.managerNotes}</td>
                </tr>
                `;

                expenseTableBody.innerHTML = tbodyHtml;
            }
    }

    async function getExpenseByStatus(){

        details = {
            method:'GET', 
            headers:{Authorization:jwt}
        };

        const expenseByStatusInput = document.getElementById("expenseByStatus")
        const status = expenseByStatusInput.value;
        const httpResponse = await fetch(`http://localhost:7000/expenses/employee/status/${EmployeeId}/${status}`, details); 
        const expenses = await httpResponse.json(); 

        let tbodyHtml = "";
        for(expense of expenses){
            tbodyHtml += `
            <tr>
                <td>${expense.expenseId}</td>
                <td>${expense.expenseAmount}</td>
                <td>${expense.reason}</td>
                <td>${expense.dateSubmitted}</td>
                <td>${expense.employeeId}</td>
                <td>${expense.managerId}</td>
                <td>${expense.status}</td>
                <td>${expense.statusDate}</td>
                <td>${expense.managerNotes}</td>
            </tr>
            `;
        }

            expenseTableBody.innerHTML = tbodyHtml;
    }

    async function getExpenseByDateSubmitted(){

        details = {
            method:'GET', 
            headers:{Authorization:jwt}
        };

        const expenseByDateSubmittedInput = document.getElementById("expenseByDateSubmitted")
        const submitDate = expenseByDateSubmittedInput.value;
        const httpResponse = await fetch(`http://localhost:7000/expenses/employee/submitdate/${EmployeeId}/${submitDate}`, details); 
        const expenses = await httpResponse.json(); 

        let tbodyHtml = "";
        for(expense of expenses){
            tbodyHtml += `
            <tr>
                <td>${expense.expenseId}</td>
                <td>${expense.expenseAmount}</td>
                <td>${expense.reason}</td>
                <td>${expense.dateSubmitted}</td>
                <td>${expense.employeeId}</td>
                <td>${expense.managerId}</td>
                <td>${expense.status}</td>
                <td>${expense.statusDate}</td>
                <td>${expense.managerNotes}</td>
            </tr>
            `;
        }

            expenseTableBody.innerHTML = tbodyHtml;
}

async function getExpenseByStatusDate(){

    details = {
            method:'GET', 
            headers:{Authorization:jwt}
        };

    const expenseByStatusDateInput = document.getElementById("expenseByStatusDate")
    const statusDate = expenseByStatusDateInput.value;
    const httpResponse = await fetch(`http://localhost:7000/expenses/employee/statusdate/${EmployeeId}/${statusDate}`, details); 
    const expenses = await httpResponse.json(); 

    let tbodyHtml = "";
    for(expense of expenses){
        tbodyHtml += `
        <tr>
            <td>${expense.expenseId}</td>
            <td>${expense.expenseAmount}</td>
            <td>${expense.reason}</td>
            <td>${expense.dateSubmitted}</td>
            <td>${expense.employeeId}</td>
            <td>${expense.managerId}</td>
            <td>${expense.status}</td>
            <td>${expense.statusDate}</td>
            <td>${expense.managerNotes}</td>
        </tr>
        `;
    }

        expenseTableBody.innerHTML = tbodyHtml;
}



    async function logout(){
        const jwt = localStorage.getItem("jwt");
        const decodedJWT = parseJWT(jwt);

        let logout = true;

        if(logout){
            window.location.href = "./login.html";
        }
}

</script>
</html>